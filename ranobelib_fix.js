var e = this && this.__assign || function () { return e = Object.assign || function (e) { for (var l, a = 1, t = arguments.length; a < t; a++)for (var u in l = arguments[a]) Object.prototype.hasOwnProperty.call(l, u) && (e[u] = l[u]); return e }, e.apply(this, arguments) }, l = this && this.__awaiter || function (e, l, a, t) { return new (a || (a = Promise))((function (u, n) { function i(e) { try { o(t.next(e)) } catch (e) { n(e) } } function r(e) { try { o(t.throw(e)) } catch (e) { n(e) } } function o(e) { var l; e.done ? u(e.value) : (l = e.value, l instanceof a ? l : new a((function (e) { e(l) }))).then(i, r) } o((t = t.apply(e, l || [])).next()) })) }, a = this && this.__generator || function (e, l) { var a, t, u, n = { label: 0, sent: function () { if (1 & u[0]) throw u[1]; return u[1] }, trys: [], ops: [] }, i = Object.create(("function" == typeof Iterator ? Iterator : Object).prototype); return i.next = r(0), i.throw = r(1), i.return = r(2), "function" == typeof Symbol && (i[Symbol.iterator] = function () { return this }), i; function r(r) { return function (o) { return function (r) { if (a) throw new TypeError("Generator is already executing."); for (; i && (i = 0, r[0] && (n = 0)), n;)try { if (a = 1, t && (u = 2 & r[0] ? t.return : r[0] ? t.throw || ((u = t.return) && u.call(t), 0) : t.next) && !(u = u.call(t, r[1])).done) return u; switch (t = 0, u && (r = [2 & r[0], u.value]), r[0]) { case 0: case 1: u = r; break; case 4: return n.label++, { value: r[1], done: !1 }; case 5: n.label++, t = r[1], r = [0]; continue; case 7: r = n.ops.pop(), n.trys.pop(); continue; default: if (!(u = n.trys, (u = u.length > 0 && u[u.length - 1]) || 6 !== r[0] && 2 !== r[0])) { n = 0; continue } if (3 === r[0] && (!u || r[1] > u[0] && r[1] < u[3])) { n.label = r[1]; break } if (6 === r[0] && n.label < u[1]) { n.label = u[1], u = r; break } if (u && n.label < u[2]) { n.label = u[2], n.ops.push(r); break } u[2] && n.ops.pop(), n.trys.pop(); continue }r = l.call(e, n) } catch (e) { r = [6, e], t = 0 } finally { a = u = 0 } if (5 & r[0]) throw r[1]; return { value: r[0] ? r[1] : void 0, done: !0 } }([r, o]) } } }, t = this && this.__importDefault || function (e) { return e && e.__esModule ? e : { default: e } }; Object.defineProperty(exports, "__esModule", { value: !0 }); var u = require("@libs/filterInputs"), n = require("@libs/defaultCover"), i = require("@libs/fetch"), r = require("@libs/novelStatus"), o = require("@libs/storage"), v = t(require("dayjs")), s = { 1: r.NovelStatus.Ongoing, 2: r.NovelStatus.Completed, 3: r.NovelStatus.OnHiatus, 4: r.NovelStatus.Cancelled }, c = function () { function t() { var e = this; this.id = "RLIB", this.name = "RanobeLib", this.site = "https://ranobelib.me", this.apiSite = "https://api.cdnlibs.org/api/manga/", this.version = "2.2.0", this.icon = "src/ru/ranobelib/icon.png", this.webStorageUtilized = !0, this.resolveUrl = function (l, a) { var t, u = (null === (t = e.user) || void 0 === t ? void 0 : t.ui) ? "ui=" + e.user.ui : ""; if (a) return e.site + "/ru/book/" + l + (u ? "?" + u : ""); var n = l.split("/"), i = n[0], r = n[1], o = n[2], v = n[3], s = i + "/read/v" + r + "/c" + o + (v ? "?bid=" + v : " "); return e.site + "/ru/" + s + (u ? (v ? "&" : "?") + u : "") }, this.getUser = function () { var e, l, a = o.storage.get("user"); if (a) return { token: { Authorization: "Bearer " + a.token }, ui: a.id }; var t = null === (e = o.localStorage.get()) || void 0 === e ? void 0 : e.auth; if (!t) return {}; var u = JSON.parse(t); return (null === (l = null == u ? void 0 : u.token) || void 0 === l ? void 0 : l.access_token) ? (o.storage.set("user", { id: u.auth.id, token: u.token.access_token }, u.token.timestamp + u.token.expires_in), { token: { Authorization: "Bearer " + u.token.access_token }, ui: u.auth.id }) : void 0 }, this.user = this.getUser(), this.filters = {/* unchanged */ } } return t.prototype.popularNovels = function (e, t) { return l(this, arguments, void 0, (function (e, l) { var t, u, r, o, v, s, c, b, d, h, p, f, g, m, y, _, k, x, S, w, j, N = l.showLatestNovels, C = l.filters; return a(this, (function (l) { switch (l.label) { case 0: return t = this.apiSite + "?site_id[0]=3&page=" + e, t += "&sort_by=" + (N ? "last_chapter_at" : (null === (o = null == C ? void 0 : C.sort_by) || void 0 === o ? void 0 : o.value) || "rating_score"), t += "&sort_type=" + ((null === (v = null == C ? void 0 : C.sort_type) || void 0 === v ? void 0 : v.value) || "desc"), (null === (s = null == C ? void 0 : C.require_chapters) || void 0 === s ? void 0 : s.value) && (t += "&chapters[min]=1"), (null === (b = null === (c = null == C ? void 0 : C.types) || void 0 === c ? void 0 : c.value) || void 0 === b ? void 0 : b.length) && (t += "&types[]=" + C.types.value.join("&types[]=")), (null === (h = null === (d = null == C ? void 0 : C.scanlateStatus) || void 0 === d ? void 0 : d.value) || void 0 === h ? void 0 : h.length) && (t += "&scanlateStatus[]=" + C.scanlateStatus.value.join("&scanlateStatus[]=")), (null === (f = null === (p = null == C ? void 0 : C.manga_status) || void 0 === p ? void 0 : p.value) || void 0 === f ? void 0 : f.length) && (t += "&manga_status[]=" + C.manga_status.value.join("&manga_status[]=")), (null == C ? void 0 : C.genres) && ((null === (m = null === (g = C.genres.value) || void 0 === g ? void 0 : g.include) || void 0 === m ? void 0 : m.length) && (t += "&genres[]=" + C.genres.value.include.join("&genres[]=")), (null === (_ = null === (y = C.genres.value) || void 0 === y ? void 0 : y.exclude) || void 0 === _ ? void 0 : _.length) && (t += "&genres_exclude[]=" + C.genres.value.exclude.join("&genres_exclude[]="))), (null == C ? void 0 : C.tags) && ((null === (x = null === (k = C.tags.value) || void 0 === k ? void 0 : k.include) || void 0 === x ? void 0 : x.length) && (t += "&tags[]=" + C.tags.value.include.join("&tags[]=")), (null === (w = null === (S = C.tags.value) || void 0 === S ? void 0 : S.exclude) || void 0 === w ? void 0 : w.length) && (t += "&tags_exclude[]=" + C.tags.value.exclude.join("&tags_exclude[]="))), [4, (0, i.fetchApi)(t, { headers: null === (j = this.user) || void 0 === j ? void 0 : j.token }).then((function (e) { return e.json() }))]; case 1: return u = l.sent(), r = [], u.data instanceof Array && u.data.forEach((function (e) { var l; return r.push({ name: e.rus_name || e.eng_name || e.name || `Novel-${e.id}`, cover: (null === (l = e.cover) || void 0 === l ? void 0 : l.default) || n.defaultCover, path: e.slug_url || e.id + "--" + e.slug }) })), [2, r] } })) })) }, t.prototype.parseNovel = function (t) { return l(this, void 0, void 0, (function () { var l, u, o, c, b, d, h, p, f, g, m, y, _, k, x, S; return a(this, (function (a) { switch (a.label) { case 0: return [4, (0, i.fetchApi)("".concat(this.apiSite).concat(t, "?fields[]=summary&fields[]=genres&fields[]=tags&fields[]=teams&fields[]=authors&fields[]=status_id&fields[]=artists"), { headers: null === (h = this.user) || void 0 === h ? void 0 : h.token }).then((function (e) { return e.json() }))]; case 1: return l = a.sent().data, u = { path: t, name: l.rus_name || l.name || `Novel-${t}`, cover: (null === (p = l.cover) || void 0 === p ? void 0 : p.default) || n.defaultCover, summary: null === (f = l.summary) || void 0 === f ? void 0 : f.trim() },/* rest unchanged */[2, u] } })) })) }, t.prototype.searchNovels = function (e) { return l(this, void 0, void 0, (function () { var l, t, u, r; return a(this, (function (a) { switch (a.label) { case 0: return l = this.apiSite + "?site_id[0]=3&q=" + e, [4, (0, i.fetchApi)(l, { headers: null === (r = this.user) || void 0 === r ? void 0 : r.token }).then((function (e) { return e.json() }))]; case 1: return t = a.sent(), u = [], t.data instanceof Array && t.data.forEach((function (e) { var l; return u.push({ name: e.rus_name || e.eng_name || e.name || `Novel-${e.id}`, cover: (null === (l = e.cover) || void 0 === l ? void 0 : l.default) || n.defaultCover, path: e.slug_url || e.id + "--" + e.slug }) })), [2, u] } })) })) }, t }(); function b(e, l, a) {/* unchanged */ } exports.default = new c;
